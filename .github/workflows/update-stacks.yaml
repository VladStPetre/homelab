name: Update docker Stack(s)

on:
  workflow_dispatch:
    inputs:
      stack_name:
        description: "Select the stack to deploy"
        type: choice
        required: true
        options:
          - ha
          - infra
          - media
          - monitoring
          - utils

concurrency:
  group: server-deploy-${{ github.repository_id }}-main
  cancel-in-progress: false

run-name: "Deploy âžœ ${{ inputs.stack_name }}"

jobs:
  deploy:
    name: "Deploy ${{ inputs.stack_name }}"
    runs-on: [self-hosted, linux, docker, stacks]
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: create env file
        run: |
          set -euo pipefail
          cat > envfile <<'EOF'
          DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}
          CUID=${{ secrets.UID }}
          CGID=${{ secrets.GID }}
          TIMEZONE=Europe/Bucharest
          GH_ORG=VladStPetre
          GH_REPO=homelab
          DOCKER_INFLUXDB_INIT_ORG=${{ secrets.DOCKER_INFLUXDB_INIT_ORG }}
          DOCKER_INFLUXDB_INIT_BUCKET=${{ secrets.DOCKER_INFLUXDB_INIT_BUCKET }}
          DOCKER_INFLUXDB_INIT_RETENTION=55w
          PIHOLE_PASS=${{ secrets.PIHOLE_PASS }}
          WG_SERVER_URL=${{ secrets.WG_SERVER_URL }}
          WG_SERVER_PORT=${{ secrets.WG_SERVER_PORT }}
          SUBDOMAIN=n8n
          N8N_HOST=${{ secrets.N8N_HOST }}
          N8N_PROTOCOL=http
          WEBHOOK_URL=${{ secrets.WEBHOOK_URL }}
          N8N_SECURE_COOKIE=false
          NODE_ENV=production
          EOF
          chmod 644 envfile

          echo "Repo root is: $GITHUB_WORKSPACE"
          ls -la
          echo "Stack dir listing:"
          ls -la "stacks/${{ inputs.stack_name }}"

          # Optional sanity check to fail early if the stack file is missing
          test -f "stacks/${{ inputs.stack_name }}/docker-stack.yaml"

      - name: Docker Stack Deploy
        uses: cssnr/stack-deploy-action@v1
        with:
          name: ${{ inputs.stack_name }}
          file: stacks/${{ inputs.stack_name }}/docker-stack.yaml
          host: ${{ secrets.DOMAIN_NAME }}
          user: deploy
          ssh_key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          env_file:  envfile
