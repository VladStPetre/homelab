---
services:
  jellyfin:
    image: jellyfin/jellyfin:2025112405
    user: root
    ports:
      - "8096:8096" # need for direct connection on TV
    environment:
      - PUID=${CUID}
      - PGID=${CGID}
      - TZ=${TIMEZONE}
      - LIBVA_DRIVER_NAME=iHD
    volumes:
      - /dev/dri:/dev/dri
      - jellyfin-data:/config
      - jellyfin-cache:/cache
      - /mnt/media:/media
    deploy:
      restart_policy:
        condition: on-failure
      update_config:
        parallelism: 1
        order: stop-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        order: stop-first
      labels:
        - "portainer.io/managed=true"
        - "io.portainer.accesscontrol.users=admin"
        - "traefik.enable=true"
        - "traefik.swarm.network=hlel"
        - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.${DOMAIN_NAME}`)"
        - "traefik.http.routers.jellyfin.entrypoints=websecure"
        - "traefik.http.routers.jellyfin.tls=true"
        - "traefik.http.routers.jellyfin.tls.certresolver=cloudflare"
        - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
    networks:
      - hlel

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:5.1.4
    ports:
      - "8081:8081"              # web UI
      - "6881:6881"              # torrent traffic TCP
      - "6881:6881/udp"          # torrent traffic UDP
    environment:
      - PUID=${CUID}                # your local user ID
      - PGID=${CGID}                # your local group ID
      - TZ=${TIMEZONE}
      - WEBUI_PORT=8081
      - UMASK=000            # sensible file perms
    volumes:
      - qbittorrent-data:/config
      - /mnt/media/Movies:/movies
      - /mnt/media/Series:/series
      - /mnt/media/Watch:/watch
    deploy:
      restart_policy:
        condition: on-failure
      update_config:
        parallelism: 1
        order: stop-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        order: stop-first
      labels:
        - "portainer.io/managed=true"
        - "io.portainer.accesscontrol.users=admin"
        - "traefik.enable=true"
        - "traefik.swarm.network=hlel"
        - "traefik.http.routers.qbittorrent.rule=Host(`qb.${DOMAIN_NAME}`)"
        - "traefik.http.routers.qbittorrent.entrypoints=websecure"
        - "traefik.http.routers.qbittorrent.tls=true"
        - "traefik.http.routers.qbittorrent.tls.certresolver=cloudflare"
        - "traefik.http.services.qbittorrent.loadbalancer.server.port=8081"
    networks:
      - hlel

volumes:
  jellyfin-data: {}
  jellyfin-cache: {}
  qbittorrent-data: {}

networks:
  hlel:
    name: hlel
    external: true