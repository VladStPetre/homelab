---
services:
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:2026.2.0
    volumes:
      - ha-data:/config
      - /etc/localtime:/etc/localtime:ro
    configs:
      - source: nas_ssh_key
        target: /config/ssh_keys/nas_ssh_key
        mode: 0600
    deploy:
      labels:
        - "portainer.io/managed=true"
        - "io.portainer.accesscontrol.users=admin"
        - "traefik.enable=true"
        - "traefik.swarm.network=hlel"
        - "traefik.http.routers.hass.rule=Host(`hass.${DOMAIN_NAME}`)"
        - "traefik.http.routers.hass.entrypoints=websecure"
        - "traefik.http.routers.hass.tls=true"
        - "traefik.http.routers.hass.tls.certresolver=cloudflare"
        - "traefik.http.services.hass.loadbalancer.server.port=8123"
      update_config:
        order: start-first
      placement:
        constraints:
          - node.labels.role == primary
    networks:
      - hlel

  influxdb:
    image: influxdb:2.8.0
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME_FILE=/run/secrets/influxdb2-admin-username
      - DOCKER_INFLUXDB_INIT_PASSWORD_FILE=/run/secrets/influxdb2-admin-password
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN_FILE=/run/secrets/influxdb2-admin-token
      - DOCKER_INFLUXDB_INIT_ORG=${DOCKER_INFLUXDB_INIT_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${DOCKER_INFLUXDB_INIT_BUCKET}
      - DOCKER_INFLUXDB_INIT_RETENTION=${DOCKER_INFLUXDB_INIT_RETENTION}
    secrets:
      - influxdb2-admin-username
      - influxdb2-admin-password
      - influxdb2-admin-token
    volumes:
      - influxdb2-config:/etc/influxdb2
      - influxdb2-data:/var/lib/influxdb2
    deploy:
      labels:
        - "portainer.io/managed=true"
        - "io.portainer.accesscontrol.users=admin"
        - "traefik.enable=true"
        - "traefik.swarm.network=hlel"
        - "traefik.http.routers.influxdb.rule=Host(`influxdb.${DOMAIN_NAME}`)"
        - "traefik.http.routers.influxdb.entrypoints=websecure"
        - "traefik.http.routers.influxdb.tls=true"
        - "traefik.http.routers.influxdb.tls.certresolver=cloudflare"
        - "traefik.http.services.influxdb.loadbalancer.server.port=8086"
      update_config:
        order: start-first
      placement:
        constraints:
          - node.labels.role == primary
    networks:
      - hlel


  mosquitto:
    image: eclipse-mosquitto:2.0.22
    ports:
      - "1883:1883"
      - "9001:9001"  # Optional WebSocket
    configs:
      - source: mosquitto_config
        target: /mosquitto/config/mosquitto.conf
    volumes:
      - mosquitto-data:/mosquitto/data
      - mosquitto-logs:/mosquitto/log
    deploy:
      labels:
        - "portainer.io/managed=true"
        - "io.portainer.accesscontrol.users=admin"
      update_config:
        order: start-first
      placement:
        constraints:
          - node.labels.role == primary
    networks:
      - hlel

  zigbee2mqtt:
    image: ghcr.io/koenkk/zigbee2mqtt:2.8.0
    environment:
      - TZ=${TIMEZONE}
    volumes:
      - z2m-data:/app/data
    deploy:
      replicas: 1
      labels:
        - "portainer.io/managed=true"
        - "io.portainer.accesscontrol.users=admin"
        - "traefik.enable=true"
        - "traefik.swarm.network=hlel"
        - "traefik.http.routers.z2m.rule=Host(`z2m.${DOMAIN_NAME}`)"
        - "traefik.http.routers.z2m.entrypoints=websecure"
        - "traefik.http.routers.z2m.tls=true"
        - "traefik.http.routers.z2m.tls.certresolver=cloudflare"
        - "traefik.http.services.z2m.loadbalancer.server.port=8080"
      update_config:
        order: start-first
      restart_policy:
        condition: any
      placement:
        constraints:
          - node.labels.role == primary
    networks:
      - hlel


configs:
  mosquitto_config:
    external: true
  nas_ssh_key:
    external: true

secrets:
  influxdb2-admin-username:
    external: true
  influxdb2-admin-password:
    external: true
  influxdb2-admin-token:
    external: true

volumes:
  ha-data: {}
  influxdb2-data: {}
  influxdb2-config: {}
  mosquitto-config: {}
  mosquitto-data: {}
  mosquitto-logs: {}
  z2m-data: {}

networks:
  hlel:
    name: hlel
    external: true